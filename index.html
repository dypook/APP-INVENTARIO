<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Inventarios">
    
    <title>Inventarios V14 (PWA)</title>
    
    <link rel="manifest" href="./manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        /* TEMA STANDARD */
        :root { --bg: #008080; --win-gray: #c0c0c0; --text: #000; --light: #fff; --shadow: #808080; --blue: #000080; --input-bg: #fff; --verif-bg: #e0ffe0; --pend-bg: #e0e0e0; --header-text: #fff; }
        /* TEMA OLED */
        body.oled-mode { --bg: #000000; --win-gray: #000000; --text: #ffffff; --light: #ffffff; --shadow: #ffffff; --blue: #000000; --input-bg: #000000; --verif-bg: #002200; --pend-bg: #222222; --header-text: #fff; }
        body.oled-mode input, body.oled-mode select, body.oled-mode textarea { color: #fff; border: 1px solid #fff; background: #000; }
        body.oled-mode .win-box { border: 1px solid #fff; }
        body.oled-mode button { background: #000; color: #fff; border: 1px solid #fff; }
        body.oled-mode .section-header { background: #000 !important; color: #fff !important; border-bottom: 1px solid #fff; }
        body.oled-mode .header-bar { border-bottom: 1px solid #fff; }
        body.oled-mode .tab.active { border-bottom: 2px solid #000; }

        body { background-color: var(--bg); font-family: "Segoe UI", sans-serif; margin: 0; padding: 5px; height: 100vh; display: flex; flex-direction: column; box-sizing: border-box; font-size: 13px; color: var(--text); overflow: hidden; user-select: none; -webkit-user-select: none; }
        .win-box { background-color: var(--win-gray); border: 2px solid; border-color: var(--light) var(--shadow) var(--shadow) var(--light); padding: 4px; margin-bottom: 8px; }
        .app-title { text-align: center; font-weight: 900; font-size: 1.2em; text-transform: uppercase; margin-bottom: 5px; color: white; text-shadow: 1px 1px 0 #000; letter-spacing: 1px; }
        .header-bar { background: var(--blue); color: var(--header-text); padding: 5px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .section-header { background: var(--shadow); color: white; padding: 2px 5px; font-weight: bold; margin-bottom: 4px; }
        .row { display: flex; gap: 5px; margin-bottom: 5px; }
        .col { flex: 1; display: flex; flex-direction: column; }
        input, select, textarea { border: 2px inset var(--shadow); background: var(--input-bg); padding: 5px; box-sizing: border-box; font-family: inherit; border-radius: 0; width: 100%; user-select: text; -webkit-user-select: text; }
        button { background: var(--win-gray); border: 2px outset var(--light); padding: 5px 10px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; text-transform: uppercase; font-size: 12px; }
        button:active { border-style: inset; padding: 6px 9px 4px 11px; }
        .btn-big { width: 100%; padding: 12px; margin-top: 5px; font-size: 14px; }
        .btn-top { font-size: 11px; padding: 3px 8px; background: #ddd; color: black; border: 1px solid white; }
        .excel-layout { display: grid; gap: 10px; }
        @media (min-width: 600px) { .excel-layout { grid-template-columns: 2fr 1fr; } }
        .left-col { display: flex; flex-direction: column; gap: 6px; }
        .right-col { display: flex; gap: 5px; justify-content: flex-end; align-items: flex-start; }
        label { font-weight: bold; font-size: 0.8em; margin-bottom: 2px; display: block; opacity: 0.8; }
        .input-short { width: 100% !important; max-width: 150px; } .input-mini { width: 60px !important; }
        .tabs { display: flex; gap: 4px; margin-bottom: -2px; z-index: 10; padding-left: 2px; }
        .tab { background: var(--win-gray); border: 2px solid var(--light); border-bottom: none; border-right-color: var(--shadow); padding: 8px 15px; cursor: pointer; border-radius: 6px 6px 0 0; opacity: 0.7; }
        .tab.active { opacity: 1; font-weight: bold; padding-bottom: 10px; z-index: 11; border-bottom: 2px solid var(--win-gray); }
        .panel { display: none; flex-grow: 1; overflow-y: auto; padding: 10px; border: 2px solid var(--light); border-color: var(--light) var(--shadow) var(--shadow) var(--light); background: var(--win-gray); -webkit-overflow-scrolling: touch; }
        .panel.active { display: block; }
        .storage-pill { padding: 2px 8px; border-radius: 12px; font-weight: bold; font-size: 0.85em; background: #333; color: #fff; border: 1px solid var(--light); }
        .prog-red { color: #ff5555; } .prog-yellow { color: #ffff55; } .prog-green { color: #55ff55; }
        .item-row { background: var(--input-bg); border: 1px solid var(--shadow); margin-bottom: 4px; display: grid; grid-template-columns: 30px 45px 1fr 30px; gap: 8px; align-items: center; padding: 5px; }
        .item-row.imported { border-left: 5px solid gray; background: var(--pend-bg); }
        .item-row.verified { border-left: 5px solid lime; background: var(--verif-bg); }
        .photo-queue { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; }
        .q-thumb { width: 60px; height: 60px; border: 1px solid #000; object-fit: cover; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-win { width: 95%; max-width: 500px; background: var(--win-gray); border: 2px outset var(--light); padding: 5px; display: flex; flex-direction: column; max-height: 90vh; }
        .folder-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 15px; padding: 10px; }
        .folder-item { display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; padding: 10px; border: 1px dotted transparent; }
        .folder-item:hover { border: 1px dotted var(--text); background: rgba(255,255,255,0.1); }
        #loading-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:3000; display:none; flex-direction:column; justify-content:center; align-items:center; color:white; }
        #offline-badge { display:none; background:red; color:white; padding:2px 5px; font-size:10px; border-radius:4px; margin-right:5px; }
    </style>
</head>
<body>
    <div id="loading-overlay"><div style="font-size:3em;">‚è≥</div><div id="loading-text" style="margin-top:10px;">Procesando...</div></div>
    <datalist id="dl-marca"></datalist><datalist id="dl-modelo"></datalist><datalist id="dl-area"></datalist><datalist id="dl-sala"></datalist>

    <div class="app-title">INVENTARIOS</div>
    <div class="win-box" style="padding: 2px;">
        <div class="header-bar">
            <span style="display:flex;align-items:center;"><span id="offline-badge">OFFLINE</span> üì¶ V14</span>
            <span style="display:flex; gap:5px; align-items:center;">
                <span id="storage-monitor" class="storage-pill">...</span>
                <span id="progress-text" style="font-weight:900;">0%</span>
                <button onclick="toggleOLED()" title="OLED" style="padding:0 6px;">‚òÄ</button>
                <button class="btn-top" onclick="openModal('modal-import')">üì•</button>
                <button class="btn-top" onclick="openModal('modal-export')">üì¶</button>
            </span>
        </div>
        <div class="row" style="margin-top:6px; align-items:center;">
            <label style="margin-left:5px;">PROYECTO:</label>
            <select id="project-select" onchange="switchProject()" style="flex:1; font-weight:bold;"></select>
            <button onclick="addProject()" style="padding:2px 8px;">‚ûï</button>
            <button onclick="deleteProject()" style="padding:2px 8px; color:red;">üóëÔ∏è</button>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="nav('tab-ingreso')">‚úèÔ∏è Ingreso</div>
        <div class="tab" onclick="nav('tab-carpetas')">üìÅ Carpetas</div>
        <div class="tab" onclick="nav('tab-lista')">üìã Lista</div>
    </div>

    <div id="tab-ingreso" class="panel active">
        <div id="edit-indicator" style="display:none; background:yellow; color:black; text-align:center; border:1px solid black; margin-bottom:10px; padding:5px;">‚ö†Ô∏è <b>EDITANDO</b> <button onclick="cancelEdit()" style="display:inline; padding:0 4px; margin-left:10px;">CANCELAR</button></div>
        <div class="excel-layout">
            <div class="left-col">
                <div class="row" style="align-items:flex-end;">
                    <div style="flex:2;"><label>ID / C√ìDIGO:</label><input type="text" id="inp-id" class="input-short" onblur="checkDup('id', this.value)" placeholder="AF-001"></div>
                    <div style="flex:1;"><label>CANT:</label><input type="number" id="inp-cant" class="input-mini" value="1"></div>
                </div>
                <div id="dup-msg" style="display:none; color:red; font-weight:bold;">‚ö†Ô∏è ¬°Duplicado!</div>
                <div><label>NOMBRE:</label><input type="text" id="inp-nombre"></div>
                <div><label>MARCA:</label><input type="text" id="inp-marca" list="dl-marca" autocomplete="off" placeholder="Buscar..."></div>
                <div><label>MODELO:</label><input type="text" id="inp-modelo" list="dl-modelo" autocomplete="off"></div>
                <div><label>SERIE:</label><input type="text" id="inp-serie" onblur="checkDup('serie', this.value)"></div>
            </div>
            <div class="right-col"><button onclick="cloneLast()">üêë CLONAR</button><button onclick="clearForm()">üßπ LIMPIAR</button></div>
        </div>
        <hr style="border:0; border-bottom:1px solid var(--shadow); margin:15px 0;">
        <div class="win-box">
            <div class="section-header">UBICACI√ìN Y ESTADO</div>
            <div class="row">
                <div class="col"><label>√Årea:</label><input type="text" id="inp-area" list="dl-area" autocomplete="off"></div>
                <div class="col"><label>Sala:</label><input type="text" id="inp-sala" list="dl-sala" autocomplete="off"></div>
            </div>
            <label>Ref. Exacta:</label><input type="text" id="inp-ref">
            <div class="row" style="margin-top:8px;">
                <div class="col"><label>Visual:</label><select id="inp-vis"><option>Bueno</option><option>Regular</option><option>Malo</option><option>Baja</option></select></div>
                <div class="col"><label>Operativo:</label><select id="inp-op"><option>Operativo</option><option>Falla Menor</option><option>Inoperativo</option></select></div>
            </div>
        </div>
        <label>Notas:</label><textarea id="inp-notas" rows="2"></textarea>
        <div class="win-box" style="margin-top:10px;">
            <div class="section-header" style="background:#000; color:white;">üì∏ EVIDENCIA</div>
            <input type="file" id="cam-input" multiple accept="image/*" style="display:none" onchange="addPhotos(this.files)">
            <button class="btn-big" onclick="document.getElementById('cam-input').click()">‚ûï AGREGAR FOTOS</button>
            <div id="photo-queue" class="photo-queue"></div>
        </div>
        <button class="btn-big" style="background:var(--blue); color:white;" onclick="saveRecord()">üíæ GUARDAR</button><br><br>
    </div>

    <div id="tab-carpetas" class="panel"><div class="row" style="justify-content:space-between;"><h3>üìÇ Explorador</h3><button onclick="renderFolders()">üîÑ</button></div><div id="folder-grid" class="folder-grid"></div></div>
    <div id="tab-lista" class="panel"><div class="win-box"><div class="row"><select id="fil-area" onchange="renderList()" class="col"><option value="">[√Åreas]</option></select><select id="fil-est" onchange="renderList()" class="col"><option value="">[Estados]</option></select></div><div class="row"><select id="fil-sort" onchange="renderList()" class="col" style="font-weight:bold;"><option value="reciente">üìÖ Reciente</option><option value="nombre">üî§ Nombre</option><option value="marca">üè≠ Marca</option><option value="ubic">üìç Ubicaci√≥n</option></select><button onclick="renderList()">üîÑ</button></div></div><input type="text" id="search-box" placeholder="üîç Buscar..." onkeyup="renderList()" style="margin-bottom:5px;"><div id="bulk-actions" style="display:none; background:#ffffcc; color:black; padding:5px; border:1px solid black; margin-bottom:5px;"><span id="bulk-count">0 sel</span><button onclick="bulkMove()">üöö MOVER</button></div><div id="list-container"></div></div>
    
    <div id="modal-import" class="modal-overlay" onclick="closeModal(event)"><div class="modal-win"><div class="header-bar">üì• IMPORTAR <button onclick="document.getElementById('modal-import').style.display='none'">X</button></div><div style="padding:15px;"><button onclick="downloadTemplate()">üìÑ Bajar Plantilla</button><hr><input type="file" id="csv-input" accept=".csv"><br><br><button class="btn-big" onclick="processImport()">PROCESAR</button></div></div></div>
    <div id="modal-export" class="modal-overlay" onclick="closeModal(event)"><div class="modal-win"><div class="header-bar">üì¶ EXPORTAR <button onclick="document.getElementById('modal-export').style.display='none'">X</button></div><div id="export-content" style="padding:15px; overflow-y:auto;"><button class="btn-big" onclick="analyzeExport()">üîÑ CALCULAR</button><div id="export-options" style="display:none; margin-top:15px;"></div></div><hr><button style="color:red; margin:5px;" onclick="nukeDB()">‚ö†Ô∏è BORRAR BD</button></div></div>
    <div id="tech-sheet" class="modal-overlay" onclick="closeModal(event)"><div class="modal-win"><div class="header-bar">FICHA <button onclick="document.getElementById('tech-sheet').style.display='none'">X</button></div><div style="background:#000; height:250px; display:flex; justify-content:center; align-items:center;"><img id="modal-img" style="max-width:100%; max-height:100%;"><span id="no-foto" style="color:white; display:none;">SIN FOTO</span></div><div style="display:flex; justify-content:center; gap:15px; padding:10px; background:#222;"><button onclick="prevPhoto()" style="color:white; border-color:white;">‚óÄ</button><span id="photo-c" style="background:#fff; color:#000; padding:2px 10px;">0/0</span><button onclick="nextPhoto()" style="color:white; border-color:white;">‚ñ∂</button></div><div id="modal-data" style="background:#fff; color:#000; padding:10px; overflow-y:auto; flex:1; font-family:monospace; border:2px inset;"></div><div class="row" style="margin-top:10px;"><button class="btn-big" onclick="generateLitePDF()">üñ®Ô∏è PDF</button><button class="btn-big" onclick="editFromModal()">‚úèÔ∏è EDITAR</button></div></div></div>
    <canvas id="thumb-canvas" style="display:none;"></canvas>

    <script>
        // --- SERVICE WORKER REGISTRATION (EL GUARDIAN) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(reg => {
                    console.log('SW Registrado: ', reg.scope);
                }, err => console.log('SW Fallo: ', err));
            });
        }
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        function updateOnlineStatus() { document.getElementById('offline-badge').style.display = navigator.onLine ? 'none' : 'inline-block'; }

        // --- APP LOGIC ---
        const DB_NAME = "InvV13_Turbo"; const DB_VER = 1; // MANTENER MISMA BD
        let db, photoQueue=[], editUUID=null, projects=[], currentProject="General";
        let curModalItem=null, curPhotoIdx=0;

        window.onload = () => {
            initDB(); updateOnlineStatus();
            projects = JSON.parse(localStorage.getItem('projects_v13')) || ['General'];
            currentProject = localStorage.getItem('cur_proj_v13') || 'General';
            loadProjectSelect();
            document.querySelectorAll("#tab-ingreso input, #tab-ingreso textarea").forEach(el => {
                el.addEventListener("input", () => { if(!editUUID) localStorage.setItem("draft_v13", JSON.stringify(getFormData())); });
            });
            loadDraft();
        };

        function getFormData() { return { id: document.getElementById("inp-id").value, nom: document.getElementById("inp-nombre").value, area: document.getElementById("inp-area").value }; }
        function loadDraft() { const d = JSON.parse(localStorage.getItem("draft_v13")); if(d && !editUUID) { document.getElementById("inp-id").value = d.id||""; document.getElementById("inp-nombre").value = d.nom||""; document.getElementById("inp-area").value = d.area||""; } }
        function initDB() { const r = indexedDB.open(DB_NAME, DB_VER); r.onupgradeneeded = e => { db = e.target.result; const s = db.createObjectStore("items", { keyPath: "uuid" }); s.createIndex("proyecto", "proyecto", { unique: false }); }; r.onsuccess = e => { db = e.target.result; renderList(); renderFolders(); updateProgress(); updateStorageManual(); updateSuggestions(); }; }
        function updateSuggestions() { if(!db) return; const tx = db.transaction(["items"], "readonly"); tx.objectStore("items").getAll().onsuccess = e => { const sets = { marca: new Set(), modelo: new Set(), area: new Set(), sala: new Set() }; e.target.result.forEach(i => { if(i.marca) sets.marca.add(i.marca.trim()); if(i.modelo) sets.modelo.add(i.modelo.trim()); if(i.area) sets.area.add(i.area.trim()); if(i.sala) sets.sala.add(i.sala.trim()); }); fillDatalist("dl-marca", sets.marca); fillDatalist("dl-modelo", sets.modelo); fillDatalist("dl-area", sets.area); fillDatalist("dl-sala", sets.sala); }; }
        function fillDatalist(id, set) { const dl = document.getElementById(id); dl.innerHTML = ""; [...set].sort().forEach(val => { const opt = document.createElement("option"); opt.value = val; dl.appendChild(opt); }); }
        async function generateThumb(file) { return new Promise(resolve => { const img = new Image(); img.src = URL.createObjectURL(file); img.onload = () => { const canvas = document.getElementById("thumb-canvas"); const ctx = canvas.getContext("2d"); const scale = 60 / img.width; canvas.width = 60; canvas.height = img.height * scale; ctx.drawImage(img, 0, 0, canvas.width, canvas.height); canvas.toBlob(blob => resolve(blob), "image/jpeg", 0.7); } }); }
        function showLoading(txt) { document.getElementById("loading-overlay").style.display="flex"; document.getElementById("loading-text").innerText=txt; }
        function hideLoading() { document.getElementById("loading-overlay").style.display="none"; }
        async function saveRecord() { const id = document.getElementById("inp-id").value.trim(); const nom = document.getElementById("inp-nombre").value.trim(); if(!id || !nom) return alert("Falta ID o Nombre"); showLoading("Guardando..."); let thumbBlob = null; if(photoQueue.length > 0) thumbBlob = await generateThumb(photoQueue[0]); const item = { uuid: editUUID || crypto.randomUUID(), proyecto: currentProject, id: id, nombre: nom, cant: document.getElementById("inp-cant").value, marca: document.getElementById("inp-marca").value.trim(), modelo: document.getElementById("inp-modelo").value.trim(), serie: document.getElementById("inp-serie").value.trim(), area: document.getElementById("inp-area").value.trim(), sala: document.getElementById("inp-sala").value.trim(), ref: document.getElementById("inp-ref").value.trim(), vis: document.getElementById("inp-vis").value, op: document.getElementById("inp-op").value, notas: document.getElementById("inp-notas").value, fotos: photoQueue.map(f => ({blob:f, name:f.name})), thumb: thumbBlob, fecha: new Date().toLocaleString(), status: "VERIFICADO" }; const tx = db.transaction(["items"], "readwrite"); tx.objectStore("items").put(item); tx.oncomplete = () => { hideLoading(); clearForm(); alert("‚úÖ OK"); renderList(); renderFolders(); updateStorageManual(); updateProgress(); updateSuggestions(); localStorage.removeItem("draft_v13"); }; }
        function renderList() { const cont = document.getElementById("list-container"); const fArea = document.getElementById("fil-area").value; const fSort = document.getElementById("fil-sort").value; const search = document.getElementById("search-box").value.toLowerCase(); cont.innerHTML="Cargando..."; const tx = db.transaction(["items"], "readonly"); tx.objectStore("items").index("proyecto").getAll(currentProject).onsuccess = e => { let items = e.target.result; const areas = [...new Set(items.map(i => (i.area||"").trim()))].sort(); const sA = document.getElementById("fil-area"); if(sA.options.length <= 1 || areas.length !== sA.options.length-1) { sA.innerHTML = '<option value="">[√Åreas]</option>'; areas.forEach(a => { if(a) sA.add(new Option(a,a)); }); if(fArea) sA.value = fArea; } if(fSort === 'reciente') items.reverse(); else items.sort((a,b) => { let va=(a.nombre||"").toLowerCase(), vb=(b.nombre||"").toLowerCase(); if(fSort==='marca') { va=(a.marca||"").toLowerCase(); vb=(b.marca||"").toLowerCase(); } if(fSort==='ubic') { va=(a.area||"").toLowerCase(); vb=(b.area||"").toLowerCase(); } return va.localeCompare(vb); }); cont.innerHTML = ""; const fragment = document.createDocumentFragment(); items.forEach(i => { if(fArea && (i.area||"").trim() !== fArea) return; if(search && !JSON.stringify(i).toLowerCase().includes(search)) return; const row = document.createElement("div"); row.className = `item-row ${i.status==='PENDIENTE'?'imported':'verified'}`; let thumbHtml = i.thumb ? `<img src="${URL.createObjectURL(i.thumb)}" style="width:100%;height:100%;object-fit:cover">` : `<div style="font-size:8px;text-align:center;padding-top:10px;">SIN FOTO</div>`; row.innerHTML = `<input type="checkbox" class="bulk-check" value="${i.uuid}" onclick="event.stopPropagation();updBulk()"><div style="width:40px;height:40px;background:#ccc;">${thumbHtml}</div><div style="overflow:hidden;"><b>${i.id}</b> ${i.nombre}<br><small>${i.area}</small></div><button onclick="event.stopPropagation();openModalTech('${i.uuid}')">üëÅÔ∏è</button>`; fragment.appendChild(row); }); cont.appendChild(fragment); } }
        function renderFolders() { const g = document.getElementById("folder-grid"); g.innerHTML=""; db.transaction(["items"]).objectStore("items").index("proyecto").getAll(currentProject).onsuccess = e => { const areasRaw = e.target.result.map(i => (i.area || "Sin √Årea").trim()); const areasUnique = [...new Set(areasRaw)].filter(a=>a).sort(); areasUnique.forEach(a => { const d = document.createElement("div"); d.className="folder-item"; d.innerHTML=`<div style="font-size:30px">üìÅ</div><div>${a}</div>`; d.onclick = () => { document.getElementById("fil-area").value = a; renderList(); nav("tab-lista"); }; g.appendChild(d); }) } }
        function loadProjectSelect() { const s = document.getElementById("project-select"); s.innerHTML=""; projects.forEach(p => s.add(new Option(p,p))); s.value = currentProject; }
        function switchProject() { currentProject = document.getElementById("project-select").value; localStorage.setItem('cur_proj_v13', currentProject); renderList(); renderFolders(); updateProgress(); updateSuggestions(); }
        function addProject() { const n = prompt("Nombre Nuevo:"); if(n && !projects.includes(n)) { projects.push(n); localStorage.setItem('projects_v13', JSON.stringify(projects)); currentProject=n; loadProjectSelect(); switchProject(); } }
        function deleteProject() { if(confirm("¬øOcultar Proyecto?")) { projects = projects.filter(p => p !== currentProject); localStorage.setItem('projects_v13', JSON.stringify(projects)); currentProject=projects[0]||"General"; loadProjectSelect(); switchProject(); } }
        function addPhotos(files) { for(let f of files) photoQueue.push(f); renderQueue(); document.getElementById("cam-input").value=""; }
        function renderQueue() { const c = document.getElementById("photo-queue"); c.innerHTML=""; photoQueue.forEach((f,i) => { const img = document.createElement("img"); img.className="q-thumb"; img.src = URL.createObjectURL(f); img.onclick=()=>{photoQueue.splice(i,1);renderQueue()}; c.appendChild(img); }); }
        function clearForm() { editUUID=null; photoQueue=[]; renderQueue(); document.querySelectorAll("#tab-ingreso input, textarea").forEach(i => i.value=""); document.getElementById("edit-indicator").style.display="none"; }
        function cloneLast() { db.transaction(["items"]).objectStore("items").openCursor(null,'prev').onsuccess = e => { const c = e.target.result; if(c && c.value.proyecto === currentProject) { const d = c.value; document.getElementById("inp-nombre").value = d.nombre; document.getElementById("inp-marca").value = d.marca; document.getElementById("inp-modelo").value = d.modelo; document.getElementById("inp-area").value = d.area; document.getElementById("inp-sala").value = d.sala; document.getElementById("inp-ref").value = d.ref; alert("Copiado"); } } }
        function openModalTech(uuid) { db.transaction(["items"]).objectStore("items").get(uuid).onsuccess = e => { curModalItem = e.target.result; curPhotoIdx = 0; document.getElementById("tech-sheet").style.display = "flex"; showModalPhoto(); document.getElementById("modal-data").innerHTML = `<b>ID:</b> ${curModalItem.id}<br><b>NOMBRE:</b> ${curModalItem.nombre}<br><b>MARCA:</b> ${curModalItem.marca}<br><b>UBIC:</b> ${curModalItem.area} - ${curModalItem.sala}`; } }
        function nav(id) { document.querySelectorAll(".panel").forEach(p=>p.classList.remove("active")); document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active")); document.getElementById(id).classList.add("active"); event.target.classList.add("active"); }
        function openModal(id){ document.getElementById(id).style.display="flex"; if(id==='modal-export') analyzeExport(); }
        function closeModal(e){ if(e.target.classList.contains("modal-overlay")) e.target.style.display="none"; }
        function toggleOLED() { document.body.classList.toggle("oled-mode"); }
        function checkDup(f,v) { if(!v || editUUID) return; db.transaction(["items"]).objectStore("items").getAll().onsuccess=e=>{ const ex = e.target.result.some(i=>i[f]===v && i.proyecto===currentProject); document.getElementById("dup-msg").style.display=ex?"block":"none"; } }
        function showModalPhoto() { const img=document.getElementById("modal-img"), lbl=document.getElementById("no-foto"); if(curModalItem.fotos.length){ img.style.display="block"; lbl.style.display="none"; img.src=URL.createObjectURL(curModalItem.fotos[curPhotoIdx].blob); document.getElementById("photo-c").innerText=`${curPhotoIdx+1}/${curModalItem.fotos.length}`; } else { img.style.display="none"; lbl.style.display="block"; } }
        function nextPhoto(){if(curModalItem.fotos.length){curPhotoIdx=(curPhotoIdx+1)%curModalItem.fotos.length;showModalPhoto()}}
        function prevPhoto(){if(curModalItem.fotos.length){curPhotoIdx=(curPhotoIdx-1+curModalItem.fotos.length)%curModalItem.fotos.length;showModalPhoto()}}
        function editFromModal(){ document.getElementById("tech-sheet").style.display="none"; loadEdit(curModalItem.uuid); }
        function loadEdit(uuid){ db.transaction(["items"]).objectStore("items").get(uuid).onsuccess=e=>{ const i=e.target.result; editUUID=uuid; document.getElementById("inp-id").value=i.id; document.getElementById("inp-nombre").value=i.nombre; document.getElementById("inp-cant").value=i.cant; document.getElementById("inp-marca").value=i.marca; document.getElementById("inp-modelo").value=i.modelo; document.getElementById("inp-serie").value=i.serie; document.getElementById("inp-area").value=i.area; document.getElementById("inp-sala").value=i.sala; document.getElementById("inp-ref").value=i.ref; document.getElementById("inp-vis").value=i.vis; document.getElementById("inp-op").value=i.op; document.getElementById("inp-notas").value=i.notas; photoQueue=i.fotos.map(f=>f.blob); renderQueue(); document.getElementById("edit-indicator").style.display="block"; nav("tab-ingreso"); } }
        function updateProgress(){ db.transaction(["items"]).objectStore("items").index("proyecto").getAll(currentProject).onsuccess=e=>{ const all=e.target.result; const ver=all.filter(i=>i.status!=="PENDIENTE").length; const pct = Math.round((ver/all.length||0)*100); const el = document.getElementById("progress-text"); el.innerText=`${pct}%`; el.className = pct<34?"prog-red":pct<67?"prog-yellow":"prog-green"; } }
        function updateStorageManual(){ db.transaction(["items"]).objectStore("items").getAll().onsuccess=e=>{ let s=0; e.target.result.forEach(i=>i.fotos.forEach(f=>s+=f.blob.size)); document.getElementById("storage-monitor").innerText=`üíæ ${(s/1024/1024).toFixed(1)}MB`; } }
        function downloadTemplate(){saveAs(new Blob(["ID;NOMBRE;CANT;MARCA;MODELO;SERIE;AREA;SALA;REF;ESTADO"],{type:"text/csv"}),"Plantilla.csv")}
        function processImport(){ const f=document.getElementById("csv-input").files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ const l=e.target.result.split("\n"); const tx=db.transaction(["items"],"readwrite"); for(let i=1;i<l.length;i++){ const c=l[i].split(";"); if(c.length>2) tx.objectStore("items").add({ uuid:crypto.randomUUID(), proyecto:currentProject, id:c[0], nombre:c[1], cant:c[2], marca:c[3], modelo:c[4], serie:c[5], area:c[6], sala:c[7], ref:c[8], vis:c[9]||"Regular", op:"Operativo", fotos:[], status:"PENDIENTE", fecha:new Date().toLocaleString() }); } tx.oncomplete=()=>{alert("Importado");renderList();updateProgress(); updateSuggestions(); document.getElementById("modal-import").style.display="none"} }; r.readAsText(f); }
        function updBulk(){document.getElementById("bulk-actions").style.display=document.querySelectorAll(".bulk-check:checked").length?"block":"none"}
        function bulkMove(){ const a=prompt("Nueva √Årea:"); if(a){ const tx=db.transaction(["items"],"readwrite"); document.querySelectorAll(".bulk-check:checked").forEach(c=>{ tx.objectStore("items").get(c.value).onsuccess=e=>{let i=e.target.result;i.area=a;tx.objectStore("items").put(i)} }); tx.oncomplete=()=>{renderList();renderFolders();alert("Movido")} } }
        function analyzeExport() { const div = document.getElementById("export-options"); div.innerHTML = "Calculando..."; div.style.display="block"; db.transaction(["items"]).objectStore("items").index("proyecto").getAll(currentProject).onsuccess = e => { const items = e.target.result; let totalSize = 0; items.forEach(i=>i.fotos.forEach(f=>totalSize+=f.blob.size)); const mb = (totalSize/1024/1024).toFixed(1); div.innerHTML = `<h4>Peso Total: ${mb} MB</h4>`; const btnCsv = document.createElement("button"); btnCsv.className="btn-big"; btnCsv.innerHTML = "üìÑ DESCARGAR SOLO CSV"; btnCsv.onclick = () => { let csv = "\uFEFFID;NOMBRE;CANT;MARCA;MODELO;SERIE;AREA;SALA;REF;VIS;OP;NOTAS\n"; items.forEach(i => { csv += `"${i.id}";"${i.nombre}";"${i.cant}";"${i.marca}";"${i.modelo}";"${i.serie}";"${i.area}";"${i.sala}";"${i.ref}";"${i.vis}";"${i.op}";"${i.notas}"\n`; }); saveAs(new Blob([csv], {type:"text/csv;charset=utf-8"}), `DATA_${currentProject}.csv`); }; div.appendChild(btnCsv); div.appendChild(document.createElement("hr")); const btnAll = document.createElement("button"); btnAll.className="btn-big"; btnAll.innerHTML = "üì¶ EXPORTAR ZIP"; if(totalSize>500*1024*1024) btnAll.style.borderColor="red"; btnAll.onclick = () => downloadBatch(items, "COMPLETO"); div.appendChild(btnAll); let batch=[], bSize=0, bNum=1; items.forEach(i => { let iSize=0; i.fotos.forEach(f=>iSize+=f.blob.size); if(bSize+iSize > 400*1024*1024 && batch.length>0) { createPartBtn(batch, bNum++); batch=[]; bSize=0; } batch.push(i); bSize+=iSize; }); if(batch.length>0) createPartBtn(batch, bNum); } }
        function createPartBtn(list, num) { const btn = document.createElement("button"); btn.className="btn-big"; btn.innerText = `üì¶ FOTOS PARTE ${num} (${list.length} items)`; btn.onclick = () => downloadBatch(list, `PARTE_${num}`); document.getElementById("export-options").appendChild(btn); }
        async function downloadBatch(list, suffix) { const zip = new JSZip(); let csv = "\uFEFFID;NOMBRE;CANT;MARCA;MODELO;SERIE;AREA;SALA;REF;VIS;OP;NOTAS\n"; list.forEach(i => { csv += `"${i.id}";"${i.nombre}";"${i.cant}";"${i.marca}";"${i.modelo}";"${i.serie}";"${i.area}";"${i.sala}";"${i.ref}";"${i.vis}";"${i.op}";"${i.notas}"\n`; if(i.fotos.length) { const fld = zip.folder(`[${i.id}]_${i.nombre.replace(/\W/g,'')}`); i.fotos.forEach((f,x) => fld.file(`${x}.jpg`, f.blob)); } }); zip.file(`DATA_${suffix}.csv`, csv); saveAs(await zip.generateAsync({type:"blob"}), `INV_${suffix}.zip`); }
        async function generateLitePDF() { const statusBtn = event.target; const originalText = statusBtn.innerText; statusBtn.innerText = "‚è≥ Comprimiendo..."; const compressImg = async (blob) => { return new Promise(resolve => { const img = new Image(); img.src = URL.createObjectURL(blob); img.onload = () => { const canvas = document.getElementById("thumb-canvas"); const ctx = canvas.getContext("2d"); const MAX_W = 800; const scale = MAX_W / img.width; canvas.width = MAX_W; canvas.height = img.height * scale; ctx.drawImage(img, 0, 0, canvas.width, canvas.height); resolve(canvas.toDataURL("image/jpeg", 0.4)); } }); }; let imgTags = ""; for (const photo of curModalItem.fotos) { const base64 = await compressImg(photo.blob); imgTags += `<div style="display:inline-block; width:30%; margin:3px; vertical-align:top;"><img src="${base64}" style="width:100%; border:1px solid #ccc;"></div>`; } const w = window.open('', '_blank'); w.document.write(`<html><head><title>${curModalItem.id}</title><style>body{font-family:sans-serif; font-size:12px;} table{width:100%; border-collapse:collapse; margin-bottom:5px;} td{border:1px solid #999; padding:4px;} th{background:#eee; text-align:left; border:1px solid #999; padding:4px;}</style></head><body><h3 style="margin:5px 0;">FICHA T√âCNICA: ${curModalItem.nombre}</h3><table><tr><th>ID / C√ìDIGO</th><td>${curModalItem.id}</td><th>FECHA</th><td>${curModalItem.fecha}</td></tr><tr><th>MARCA</th><td>${curModalItem.marca}</td><th>MODELO</th><td>${curModalItem.modelo}</td></tr><tr><th>SERIE</th><td>${curModalItem.serie}</td><th>CANTIDAD</th><td>${curModalItem.cant}</td></tr><tr><th>UBICACI√ìN</th><td>${curModalItem.area} - ${curModalItem.sala}</td><th>REF. EXACTA</th><td>${curModalItem.ref}</td></tr><tr><th>ESTADO VISUAL</th><td>${curModalItem.vis}</td><th>OPERATIVO</th><td>${curModalItem.op}</td></tr><tr><th colspan="4">NOTAS</th></tr><tr><td colspan="4" style="height:40px; vertical-align:top;">${curModalItem.notas}</td></tr></table><div style="text-align:center;">${imgTags}</div></body></html>`); w.document.close(); statusBtn.innerText = originalText; setTimeout(() => w.print(), 500); }
        function nukeDB(){if(confirm("¬øBORRAR TODO?")){indexedDB.deleteDatabase(DB_NAME);location.reload()}}
    </script>
</body>
</html>